<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Four-Engine Dev Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }

        .header {
            background: #2563eb;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
        }

        .header p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .panel h2 {
            margin-top: 0;
            color: #1f2937;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-healthy { background: #10b981; }
        .status-warning { background: #f59e0b; }
        .status-error { background: #ef4444; }

        .trace-log {
            max-height: 400px;
            overflow-y: auto;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .trace-entry {
            margin-bottom: 8px;
            padding: 8px;
            border-left: 3px solid #e5e7eb;
            background: white;
        }

        .trace-entry:hover {
            background: #f1f5f9;
        }

        .trace-calc-id {
            font-weight: bold;
            color: #2563eb;
        }

        .trace-entity {
            color: #059669;
            font-weight: 500;
        }

        .trace-field {
            color: #7c3aed;
        }

        .trace-explanation {
            margin-top: 4px;
            color: #374151;
        }

        .trace-metadata {
            margin-top: 4px;
            font-size: 11px;
            color: #6b7280;
        }

        .engine-state {
            display: grid;
            gap: 10px;
        }

        .state-section {
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 12px;
        }

        .state-section h3 {
            margin: 0 0 8px 0;
            color: #1f2937;
            font-size: 14px;
        }

        .state-value {
            font-family: monospace;
            background: #f8fafc;
            padding: 4px 8px;
            border-radius: 3px;
            border: 1px solid #e2e8f0;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
        }

        .json-viewer {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 12px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .calc-item {
            cursor: pointer;
            padding: 8px 12px;
            margin-bottom: 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .calc-item:hover {
            background: #e5e7eb;
        }

        .calc-item.selected {
            background: #dbeafe;
            border: 1px solid #2563eb;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß Four-Engine Dev Dashboard</h1>
        <p>Real-time visualization of TraceLogs, Engine States, Domain Structure, and Rule Sets for the modular Calculation Engine</p>
    </div>

    <div class="controls">
        <button class="btn btn-primary" onclick="refreshData()">üîÑ Refresh Data</button>
        <button class="btn btn-secondary" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
        <button class="btn btn-secondary" onclick="toggleAutoRefresh()">
            <span id="autoRefreshText">‚ñ∂Ô∏è Start Auto-Refresh</span>
        </button>
    </div>

    <div id="errorContainer"></div>

    <div class="dashboard-grid">
        <div class="panel">
            <h2>üìä System Status</h2>
            <div id="systemStatus">
                <p><span class="status-indicator status-healthy"></span>Backend: <span id="backendStatus">Checking...</span></p>
                <p><span class="status-indicator status-healthy"></span>Database: <span id="databaseStatus">Checking...</span></p>
                <p><span class="status-indicator status-healthy"></span>Rule Loader: <span id="ruleLoaderStatus">Checking...</span></p>
            </div>
        </div>

        <div class="panel">
            <h2>‚öôÔ∏è Engine States</h2>
            <div id="engineStates" class="engine-state">
                <div class="state-section">
                    <h3>Calculation Engine</h3>
                    <div id="calcEngineState">Loading...</div>
                </div>
                <div class="state-section">
                    <h3>Projection Engine</h3>
                    <div id="projectionEngineState">Loading...</div>
                </div>
                <div class="state-section">
                    <h3>Strategy Engine</h3>
                    <div id="strategyEngineState">Loading...</div>
                </div>
                <div class="state-section">
                    <h3>LLM Orchestrator</h3>
                    <div id="llmEngineState">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="panel">
        <h2>üìã Trace Logs</h2>
        <div id="traceLogs" class="trace-log">
            <div class="trace-entry">
                <div>Loading trace logs...</div>
            </div>
        </div>
    </div>

    <div class="panel">
        <h2>üèóÔ∏è Calculation Domains</h2>
        <div id="calculationDomains" class="engine-state">
            <div class="state-section">
                <h3>Tax Personal Domain (tax_personal.py)</h3>
                <div class="state-value">CAL-PIT-001: PAYG tax calculation</div>
                <div class="state-value">CAL-PIT-002: Medicare levy</div>
                <div class="state-value">CAL-PIT-004: Tax offsets (LITO)</div>
                <div class="state-value">CAL-PIT-005: Net tax payable</div>
            </div>
            <div class="state-section">
                <h3>Capital Gains Domain (cgt.py)</h3>
                <div class="state-value">CAL-CGT-001: Capital gain/loss on disposal</div>
                <div class="state-value">CAL-CGT-002: CGT discount (individuals)</div>
            </div>
            <div class="state-section">
                <h3>Superannuation Domain (superannuation.py)</h3>
                <div class="state-value">CAL-SUP-002: Total concessional contributions</div>
                <div class="state-value">CAL-SUP-003: Concessional cap utilisation</div>
                <div class="state-value">CAL-SUP-007: Contributions tax</div>
                <div class="state-value">CAL-SUP-008: Division 293 tax</div>
                <div class="state-value">CAL-SUP-009: Net contribution to balance</div>
            </div>
            <div class="state-section">
                <h3>Property Domain (property.py)</h3>
                <div class="state-value">CAL-PFL-104: Negative gearing benefit</div>
            </div>
        </div>
    </div>

    <div class="panel">
        <h2>üßÆ Calculation Browser</h2>
        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <h3>Available Calculations</h3>
                <div id="calculationList" class="engine-state" style="max-height: 1600px; overflow-y: auto;">
                    <div class="state-value calc-item" onclick="showCalculationDetails('CAL-PIT-001')">
                        <strong>CAL-PIT-001</strong> - PAYG Tax Calculation
                    </div>
                    <div class="state-value calc-item" onclick="showCalculationDetails('CAL-PIT-002')">
                        <strong>CAL-PIT-002</strong> - Medicare Levy
                    </div>
                    <div class="state-value calc-item" onclick="showCalculationDetails('CAL-PIT-004')">
                        <strong>CAL-PIT-004</strong> - Tax Offsets (LITO)
                    </div>
                    <div class="state-value calc-item" onclick="showCalculationDetails('CAL-PIT-005')">
                        <strong>CAL-PIT-005</strong> - Net Tax Payable
                    </div>
                    <div class="state-value calc-item" onclick="showCalculationDetails('CAL-CGT-001')">
                        <strong>CAL-CGT-001</strong> - Capital Gain/Loss
                    </div>
                    <div class="state-value calc-item" onclick="showCalculationDetails('CAL-CGT-002')">
                        <strong>CAL-CGT-002</strong> - CGT Discount
                    </div>
                    <div class="state-value calc-item" onclick="showCalculationDetails('CAL-SUP-002')">
                        <strong>CAL-SUP-002</strong> - Total Concessional Contributions
                    </div>
                    <div class="state-value calc-item" onclick="showCalculationDetails('CAL-SUP-003')">
                        <strong>CAL-SUP-003</strong> - Concessional Cap Utilisation
                    </div>
                    <div class="state-value calc-item" onclick="showCalculationDetails('CAL-SUP-007')">
                        <strong>CAL-SUP-007</strong> - Contributions Tax
                    </div>
                    <div class="state-value calc-item" onclick="showCalculationDetails('CAL-SUP-008')">
                        <strong>CAL-SUP-008</strong> - Division 293 Tax
                    </div>
                    <div class="state-value calc-item" onclick="showCalculationDetails('CAL-SUP-009')">
                        <strong>CAL-SUP-009</strong> - Net Super Contribution
                    </div>
                    <div class="state-value calc-item" onclick="showCalculationDetails('CAL-PFL-104')">
                        <strong>CAL-PFL-104</strong> - Negative Gearing Benefit
                    </div>
                </div>
            </div>
            <div style="flex: 3;">
                <h3>Calculation Details</h3>
                <div id="calculationDetails" class="json-viewer" style="max-height: 1600px; overflow-y: auto;">
                    <em>Click on a calculation above to view details</em>
                </div>
            </div>
        </div>
    </div>

    <div class="panel">
        <h2>üìã Rule Sets</h2>
        <div id="ruleSets" class="json-viewer">
            Loading rule configurations...
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let backendUrl = 'http://localhost:8000';

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
        });

        async function refreshData() {
            try {
                document.body.classList.add('loading');
                clearErrors();

                await Promise.all([
                    checkSystemStatus(),
                    loadTraceLogs(),
                    loadEngineStates(),
                    loadCalculationDomains(),
                    loadRuleSets()
                ]);

            } catch (error) {
                showError('Failed to refresh data: ' + error.message);
            } finally {
                document.body.classList.remove('loading');
            }
        }

        async function checkSystemStatus() {
            try {
                // Check backend health
                const healthResponse = await fetch(`${backendUrl}/health`);
                const isHealthy = healthResponse.ok;

                document.getElementById('backendStatus').textContent =
                    isHealthy ? 'Healthy' : 'Unhealthy';
                document.getElementById('backendStatus').previousElementSibling.className =
                    `status-indicator ${isHealthy ? 'status-healthy' : 'status-error'}`;

                // Database status (simplified - would need actual DB health endpoint)
                document.getElementById('databaseStatus').textContent = 'Connected';

                // Rule loader status
                document.getElementById('ruleLoaderStatus').textContent = 'Loaded';

                // Add registry status
                const registryStatus = document.createElement('p');
                registryStatus.innerHTML = '<span class="status-indicator status-healthy"></span>Calculation Registry: <span id="registryStatus">12 functions registered</span>';
                document.getElementById('systemStatus').appendChild(registryStatus);

            } catch (error) {
                document.getElementById('backendStatus').textContent = 'Offline';
                document.getElementById('backendStatus').previousElementSibling.className =
                    'status-indicator status-error';
            }
        }

        async function loadTraceLogs() {
            try {
                // Updated trace logs showing examples from the new domain structure
                const logsContainer = document.getElementById('traceLogs');
                logsContainer.innerHTML = `
                    <div class="trace-entry">
                        <div class="trace-calc-id">CAL-PIT-001</div>
                        <div class="trace-entity">Entity: person_1</div>
                        <div class="trace-field">Field: tax_payable</div>
                        <div class="trace-explanation">PAYG tax calculated for resident on taxable income (Tax Personal Domain)</div>
                        <div class="trace-metadata">{"assessable_income": 75000, "deductions": 0, "taxable_income": 75000, "tax_brackets_applied": 3}</div>
                    </div>
                    <div class="trace-entry">
                        <div class="trace-calc-id">CAL-PIT-002</div>
                        <div class="trace-entity">Entity: person_1</div>
                        <div class="trace-field">Field: medicare_levy</div>
                        <div class="trace-explanation">Medicare levy calculated at 2% on income above threshold (Tax Personal Domain)</div>
                        <div class="trace-metadata">{"taxable_income": 75000, "threshold": 23220, "rate": 0.02, "levy_payable": 1035.60}</div>
                    </div>
                    <div class="trace-entry">
                        <div class="trace-calc-id">CAL-SUP-002</div>
                        <div class="trace-entity">Entity: person_1</div>
                        <div class="trace-field">Field: total_concessional_contributions</div>
                        <div class="trace-explanation">Total concessional contributions calculated (Superannuation Domain)</div>
                        <div class="trace-metadata">{"employer_sg": 15000, "salary_sacrifice": 5000, "personal_deductible": 2000, "total": 22000}</div>
                    </div>
                    <div class="trace-entry">
                        <div class="trace-calc-id">CAL-CGT-001</div>
                        <div class="trace-entity">Entity: person_1</div>
                        <div class="trace-field">Field: capital_gain</div>
                        <div class="trace-explanation">Capital gain/loss calculated on asset disposal (CGT Domain)</div>
                        <div class="trace-metadata">{"proceeds": 200000, "cost_base": 150000, "capital_gain": 50000}</div>
                    </div>
                    <div class="trace-entry">
                        <div class="trace-calc-id">CAL-PFL-104</div>
                        <div class="trace-entity">Entity: person_1</div>
                        <div class="trace-field">Field: negative_gearing_benefit</div>
                        <div class="trace-explanation">Negative gearing tax benefit calculated (Property Domain)</div>
                        <div class="trace-metadata">{"property_interest": 25000, "rental_income": 15000, "deductible_loss": 10000, "marginal_rate": 0.32, "tax_benefit": 3200}</div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('traceLogs').innerHTML =
                    '<div class="trace-entry">Failed to load trace logs</div>';
            }
        }

        async function loadEngineStates() {
            // Updated engine states reflecting the new modular structure
            document.getElementById('calcEngineState').innerHTML = `
                <div class="state-value">Registry Functions: 12</div>
                <div class="state-value">Domain Modules: 4</div>
                <div class="state-value">Tax Domain: CAL-PIT-001,002,004,005</div>
                <div class="state-value">CGT Domain: CAL-CGT-001,002</div>
                <div class="state-value">Super Domain: CAL-SUP-002,003,007,008,009</div>
                <div class="state-value">Property Domain: CAL-PFL-104</div>
            `;

            document.getElementById('projectionEngineState').innerHTML = `
                <div class="state-value">Uses Registry: Yes</div>
                <div class="state-value">Years Projected: 30</div>
                <div class="state-value">Active Scenarios: 3</div>
                <div class="state-value">Registry Lookups: Enabled</div>
            `;

            document.getElementById('strategyEngineState').innerHTML = `
                <div class="state-value">Status: Idle</div>
                <div class="state-value">Last Run: Never</div>
            `;

            document.getElementById('llmEngineState').innerHTML = `
                <div class="state-value">Status: Disconnected</div>
                <div class="state-value">Prompts Loaded: 0</div>
            `;
        }

        async function loadCalculationDomains() {
            // Domain structure is already shown in the HTML - this could be made dynamic
            // if we add an endpoint to list available domains and functions
            document.getElementById('calculationDomains').style.opacity = '1';
        }

        async function loadRuleSets() {
            try {
                // Updated rule sets showing the actual RuleLoader structure
                const rulesContainer = document.getElementById('ruleSets');
                rulesContainer.textContent = JSON.stringify({
                    tax: {
                        brackets: [
                            { min: 0, max: 18200, rate: 0.0 },
                            { min: 18201, max: 45000, rate: 0.16 },
                            { min: 45001, max: 120000, rate: 0.30 },
                            { min: 120001, max: 180000, rate: 0.37 }
                        ],
                        medicare_levy_rate: 0.02,
                        medicare_levy_thresholds: {
                            single: 23220,
                            family: 39176
                        },
                        lito_parameters: {
                            max_offset: 700,
                            income_limit: 37500,
                            phase_out_start: 37500,
                            phase_out_rate: 0.05
                        }
                    },
                    superannuation: {
                        concessional_cap: 11000,
                        contributions_tax_rate: 0.15,
                        division_293_threshold: 250000,
                        division_293_rate: 0.15
                    },
                    capital_gains: {
                        individual_discount_rate: 0.50
                    },
                    property: {
                        marginal_tax_rate: 0.32
                    }
                }, null, 2);
            } catch (error) {
                document.getElementById('ruleSets').textContent = 'Failed to load rule sets';
            }
        }

        function clearLogs() {
            document.getElementById('traceLogs').innerHTML =
                '<div class="trace-entry">Logs cleared</div>';
        }

        function toggleAutoRefresh() {
            const buttonText = document.getElementById('autoRefreshText');

            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                buttonText.textContent = '‚ñ∂Ô∏è Start Auto-Refresh';
            } else {
                autoRefreshInterval = setInterval(refreshData, 5000);
                buttonText.textContent = '‚è∏Ô∏è Stop Auto-Refresh';
                refreshData(); // Immediate refresh
            }
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error">${message}</div>`;
        }

        function clearErrors() {
            document.getElementById('errorContainer').innerHTML = '';
        }

        function showCalculationDetails(calcId) {
            // Remove selected class from all items
            document.querySelectorAll('.calc-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Add selected class to clicked item
            event.target.classList.add('selected');

            const detailsContainer = document.getElementById('calculationDetails');

            // Calculation details database
            const calculationDetails = {
                'CAL-PIT-001': {
                    id: 'CAL-PIT-001',
                    name: 'PAYG Tax Calculation',
                    domain: 'Personal Income Tax (tax_personal.py)',
                    description: 'Calculates Australian PAYG (Pay As You Go) income tax for residents using progressive tax brackets.',
                    inputs: [
                        'CalculationState with cashflow data',
                        'entity_id (string)',
                        'year_index (int, default 0)'
                    ],
                    logic: [
                        'Extract assessable income from salary/wages',
                        'Calculate taxable income (assessable - deductions)',
                        'Apply progressive tax brackets from RuleLoader',
                        'Calculate tax using marginal rates'
                    ],
                    outputs: 'CalculationResult with tax_payable (Decimal)',
                    rules_used: [
                        'Tax brackets (min/max/rate)',
                        'Taxable income calculation rules'
                    ],
                    dependencies: 'None',
                    file: 'backend/src/engines/calculation/domains/tax_personal.py'
                },
                'CAL-PIT-002': {
                    id: 'CAL-PIT-002',
                    name: 'Medicare Levy',
                    domain: 'Personal Income Tax (tax_personal.py)',
                    description: 'Calculates Medicare levy with threshold exemption.',
                    inputs: [
                        'CalculationState with tax results',
                        'entity_id (string)',
                        'year_index (int, default 0)'
                    ],
                    logic: [
                        'Get taxable income from CAL-PIT-001 results',
                        'Apply Medicare levy rate from RuleLoader',
                        'Check threshold exemption',
                        'Calculate levy if income exceeds threshold'
                    ],
                    outputs: 'CalculationResult with medicare_levy (Decimal)',
                    rules_used: [
                        'Medicare levy rate',
                        'Medicare levy thresholds (single/family)'
                    ],
                    dependencies: 'CAL-PIT-001 (taxable income)',
                    file: 'backend/src/engines/calculation/domains/tax_personal.py'
                },
                'CAL-PIT-004': {
                    id: 'CAL-PIT-004',
                    name: 'Tax Offsets (LITO)',
                    domain: 'Personal Income Tax (tax_personal.py)',
                    description: 'Calculates Low Income Tax Offset (LITO) with phase-out rules.',
                    inputs: [
                        'CalculationState with tax results',
                        'entity_id (string)',
                        'year_index (int, default 0)'
                    ],
                    logic: [
                        'Get taxable income from CAL-PIT-001 results',
                        'Apply LITO parameters from RuleLoader',
                        'Calculate offset amount with phase-out rules',
                        'Apply income limits and reduction rates'
                    ],
                    outputs: 'CalculationResult with tax_offsets (Decimal)',
                    rules_used: [
                        'LITO max offset amount',
                        'LITO income limit and phase-out parameters',
                        'LITO phase-out rate'
                    ],
                    dependencies: 'CAL-PIT-001 (taxable income)',
                    file: 'backend/src/engines/calculation/domains/tax_personal.py'
                },
                'CAL-PIT-005': {
                    id: 'CAL-PIT-005',
                    name: 'Net Tax Payable',
                    domain: 'Personal Income Tax (tax_personal.py)',
                    description: 'Calculates final net tax position including withholdings and offsets.',
                    inputs: [
                        'CalculationState with tax results',
                        'entity_id (string)',
                        'year_index (int, default 0)'
                    ],
                    logic: [
                        'Sum PAYG tax and Medicare levy',
                        'Subtract tax offsets',
                        'Subtract PAYG withholdings',
                        'Determine if refund or additional payment required'
                    ],
                    outputs: 'CalculationResult with net_tax_payable (Decimal)',
                    rules_used: 'None (aggregation calculation)',
                    dependencies: 'CAL-PIT-001, CAL-PIT-002, CAL-PIT-004',
                    file: 'backend/src/engines/calculation/domains/tax_personal.py'
                },
                'CAL-CGT-001': {
                    id: 'CAL-CGT-001',
                    name: 'Capital Gain/Loss',
                    domain: 'Capital Gains Tax (cgt.py)',
                    description: 'Calculates capital gain or loss on asset disposal.',
                    inputs: [
                        'CalculationState with asset data',
                        'entity_id (string)',
                        'year_index (int, default 0)'
                    ],
                    logic: [
                        'Extract asset disposal data',
                        'Calculate gain/loss: proceeds - cost_base',
                        'Apply any reductions or adjustments',
                        'Return net capital gain/loss'
                    ],
                    outputs: 'CalculationResult with capital_gain (Decimal)',
                    rules_used: 'Asset disposal valuation rules',
                    dependencies: 'Asset disposal data in state',
                    file: 'backend/src/engines/calculation/domains/cgt.py'
                },
                'CAL-CGT-002': {
                    id: 'CAL-CGT-002',
                    name: 'CGT Discount',
                    domain: 'Capital Gains Tax (cgt.py)',
                    description: 'Applies 50% CGT discount for individuals on capital gains.',
                    inputs: [
                        'CalculationState with CGT results',
                        'entity_id (string)',
                        'year_index (int, default 0)'
                    ],
                    logic: [
                        'Get capital gain from CAL-CGT-001',
                        'Apply CGT discount rate from RuleLoader',
                        'Calculate discounted gain',
                        'Return both original and discounted amounts'
                    ],
                    outputs: 'CalculationResult with discounted_gain (Decimal)',
                    rules_used: [
                        'CGT discount rate for individuals (50%)'
                    ],
                    dependencies: 'CAL-CGT-001 (capital gain)',
                    file: 'backend/src/engines/calculation/domains/cgt.py'
                },
                'CAL-SUP-002': {
                    id: 'CAL-SUP-002',
                    name: 'Total Concessional Contributions',
                    domain: 'Superannuation (superannuation.py)',
                    description: 'Sums all concessional (pre-tax) superannuation contributions.',
                    inputs: [
                        'CalculationState with cashflow data',
                        'entity_id (string)',
                        'year_index (int, default 0)'
                    ],
                    logic: [
                        'Extract employer SG contributions',
                        'Extract salary sacrifice amounts',
                        'Extract personal deductible contributions',
                        'Sum all concessional contributions'
                    ],
                    outputs: 'CalculationResult with total_concessional (Decimal)',
                    rules_used: 'Concessional contribution definitions',
                    dependencies: 'Cashflow data with super contributions',
                    file: 'backend/src/engines/calculation/domains/superannuation.py'
                },
                'CAL-SUP-003': {
                    id: 'CAL-SUP-003',
                    name: 'Concessional Cap Utilisation',
                    domain: 'Superannuation (superannuation.py)',
                    description: 'Checks utilisation against concessional contributions cap.',
                    inputs: [
                        'CalculationState with super results',
                        'entity_id (string)',
                        'year_index (int, default 0)'
                    ],
                    logic: [
                        'Get total concessional from CAL-SUP-002',
                        'Compare against concessional cap from RuleLoader',
                        'Calculate utilised, remaining, and excess amounts'
                    ],
                    outputs: 'CalculationResult with utilised_amount (Decimal)',
                    rules_used: [
                        'Concessional contributions cap limit'
                    ],
                    dependencies: 'CAL-SUP-002 (total concessional)',
                    file: 'backend/src/engines/calculation/domains/superannuation.py'
                },
                'CAL-SUP-007': {
                    id: 'CAL-SUP-007',
                    name: 'Contributions Tax',
                    domain: 'Superannuation (superannuation.py)',
                    description: 'Calculates 15% contributions tax on concessional contributions.',
                    inputs: [
                        'CalculationState with super results',
                        'entity_id (string)',
                        'year_index (int, default 0)'
                    ],
                    logic: [
                        'Get total concessional from CAL-SUP-002',
                        'Apply 15% contributions tax rate from RuleLoader',
                        'Calculate tax amount'
                    ],
                    outputs: 'CalculationResult with contributions_tax (Decimal)',
                    rules_used: [
                        'Super contributions tax rate (15%)'
                    ],
                    dependencies: 'CAL-SUP-002 (total concessional)',
                    file: 'backend/src/engines/calculation/domains/superannuation.py'
                },
                'CAL-SUP-008': {
                    id: 'CAL-SUP-008',
                    name: 'Division 293 Tax',
                    domain: 'Superannuation (superannuation.py)',
                    description: 'Calculates Division 293 additional tax for high income earners.',
                    inputs: [
                        'CalculationState with tax and super results',
                        'entity_id (string)',
                        'year_index (int, default 0)'
                    ],
                    logic: [
                        'Get adjusted taxable income (ATI)',
                        'Check against Division 293 threshold',
                        'If ATI > threshold, apply additional tax rate',
                        'Tax amount = concessional contributions √ó additional rate'
                    ],
                    outputs: 'CalculationResult with division_293_tax (Decimal)',
                    rules_used: [
                        'Division 293 threshold',
                        'Division 293 additional tax rate'
                    ],
                    dependencies: 'CAL-PIT-001 (ATI), CAL-SUP-002 (concessional)',
                    file: 'backend/src/engines/calculation/domains/superannuation.py'
                },
                'CAL-SUP-009': {
                    id: 'CAL-SUP-009',
                    name: 'Net Super Contribution',
                    domain: 'Superannuation (superannuation.py)',
                    description: 'Calculates net super balance increase after all taxes.',
                    inputs: [
                        'CalculationState with super results',
                        'entity_id (string)',
                        'year_index (int, default 0)'
                    ],
                    logic: [
                        'Get gross concessional contributions',
                        'Subtract contributions tax (15%)',
                        'Subtract Division 293 tax (if applicable)',
                        'Return net amount added to super balance'
                    ],
                    outputs: 'CalculationResult with net_contribution (Decimal)',
                    rules_used: 'Tax rate calculations',
                    dependencies: 'CAL-SUP-002, CAL-SUP-007, CAL-SUP-008',
                    file: 'backend/src/engines/calculation/domains/superannuation.py'
                },
                'CAL-PFL-104': {
                    id: 'CAL-PFL-104',
                    name: 'Negative Gearing Benefit',
                    domain: 'Property Investment (property.py)',
                    description: 'Calculates tax benefit from negative gearing on investment properties.',
                    inputs: [
                        'CalculationState with property and tax data',
                        'entity_id (string)',
                        'year_index (int, default 0)'
                    ],
                    logic: [
                        'Get property interest expenses',
                        'Get rental income from property',
                        'Calculate deductible loss',
                        'Apply marginal tax rate from RuleLoader',
                        'Return tax benefit amount'
                    ],
                    outputs: 'CalculationResult with tax_benefit (Decimal)',
                    rules_used: [
                        'Marginal tax rate for property calculations'
                    ],
                    dependencies: 'Property loan and income data',
                    file: 'backend/src/engines/calculation/domains/property.py'
                }
            };

            const details = calculationDetails[calcId];
            if (details) {
                detailsContainer.innerHTML = `
                    <div style="margin-bottom: 12px;">
                        <strong style="color: #2563eb; font-size: 14px;">${details.id}</strong>
                        <span style="color: #6b7280;">- ${details.name}</span>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>Domain:</strong> ${details.domain}
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>Description:</strong> ${details.description}
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>Inputs:</strong>
                        <ul style="margin: 4px 0; padding-left: 20px;">
                            ${details.inputs.map(input => `<li>${input}</li>`).join('')}
                        </ul>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>Logic:</strong>
                        <ol style="margin: 4px 0; padding-left: 20px;">
                            ${details.logic.map(step => `<li>${step}</li>`).join('')}
                        </ol>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>Outputs:</strong> ${details.outputs}
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>Rules Used:</strong>
                        ${Array.isArray(details.rules_used) ?
                            `<ul style="margin: 4px 0; padding-left: 20px;">
                                ${details.rules_used.map(rule => `<li>${rule}</li>`).join('')}
                            </ul>` :
                            details.rules_used}
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>Dependencies:</strong> ${details.dependencies}
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>File:</strong> <code>${details.file}</code>
                    </div>
                `;
            } else {
                detailsContainer.innerHTML = `<em>Details not available for ${calcId}</em>`;
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey || event.metaKey) {
                switch(event.key) {
                    case 'r':
                        event.preventDefault();
                        refreshData();
                        break;
                    case 'c':
                        event.preventDefault();
                        clearLogs();
                        break;
                }
            }
        });
    </script>
</body>
</html>

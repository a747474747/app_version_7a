<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Four-Engine Dev Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }

        .header {
            background: #2563eb;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
        }

        .header p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .panel h2 {
            margin-top: 0;
            color: #1f2937;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-healthy { background: #10b981; }
        .status-warning { background: #f59e0b; }
        .status-error { background: #ef4444; }

        .trace-log {
            max-height: 400px;
            overflow-y: auto;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .trace-entry {
            margin-bottom: 8px;
            padding: 8px;
            border-left: 3px solid #e5e7eb;
            background: white;
        }

        .trace-entry:hover {
            background: #f1f5f9;
        }

        .trace-calc-id {
            font-weight: bold;
            color: #2563eb;
        }

        .trace-entity {
            color: #059669;
            font-weight: 500;
        }

        .trace-field {
            color: #7c3aed;
        }

        .trace-explanation {
            margin-top: 4px;
            color: #374151;
        }

        .trace-metadata {
            margin-top: 4px;
            font-size: 11px;
            color: #6b7280;
        }

        .engine-state {
            display: grid;
            gap: 10px;
        }

        .state-section {
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 12px;
        }

        .state-section h3 {
            margin: 0 0 8px 0;
            color: #1f2937;
            font-size: 14px;
        }

        .state-value {
            font-family: monospace;
            background: #f8fafc;
            padding: 4px 8px;
            border-radius: 3px;
            border: 1px solid #e2e8f0;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
        }

        .json-viewer {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 12px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß Four-Engine Dev Dashboard</h1>
        <p>Real-time visualization of TraceLogs, Engine States, Domain Structure, and Rule Sets for the modular Calculation Engine</p>
    </div>

    <div class="controls">
        <button class="btn btn-primary" onclick="refreshData()">üîÑ Refresh Data</button>
        <button class="btn btn-secondary" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
        <button class="btn btn-secondary" onclick="toggleAutoRefresh()">
            <span id="autoRefreshText">‚ñ∂Ô∏è Start Auto-Refresh</span>
        </button>
    </div>

    <div id="errorContainer"></div>

    <div class="dashboard-grid">
        <div class="panel">
            <h2>üìä System Status</h2>
            <div id="systemStatus">
                <p><span class="status-indicator status-healthy"></span>Backend: <span id="backendStatus">Checking...</span></p>
                <p><span class="status-indicator status-healthy"></span>Database: <span id="databaseStatus">Checking...</span></p>
                <p><span class="status-indicator status-healthy"></span>Rule Loader: <span id="ruleLoaderStatus">Checking...</span></p>
            </div>
        </div>

        <div class="panel">
            <h2>‚öôÔ∏è Engine States</h2>
            <div id="engineStates" class="engine-state">
                <div class="state-section">
                    <h3>Calculation Engine</h3>
                    <div id="calcEngineState">Loading...</div>
                </div>
                <div class="state-section">
                    <h3>Projection Engine</h3>
                    <div id="projectionEngineState">Loading...</div>
                </div>
                <div class="state-section">
                    <h3>Strategy Engine</h3>
                    <div id="strategyEngineState">Loading...</div>
                </div>
                <div class="state-section">
                    <h3>LLM Orchestrator</h3>
                    <div id="llmEngineState">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="panel">
        <h2>üìã Trace Logs</h2>
        <div id="traceLogs" class="trace-log">
            <div class="trace-entry">
                <div>Loading trace logs...</div>
            </div>
        </div>
    </div>

    <div class="panel">
        <h2>üèóÔ∏è Calculation Domains</h2>
        <div id="calculationDomains" class="engine-state">
            <div class="state-section">
                <h3>Tax Personal Domain (tax_personal.py)</h3>
                <div class="state-value">CAL-PIT-001: PAYG tax calculation</div>
                <div class="state-value">CAL-PIT-002: Medicare levy</div>
                <div class="state-value">CAL-PIT-004: Tax offsets (LITO)</div>
                <div class="state-value">CAL-PIT-005: Net tax payable</div>
            </div>
            <div class="state-section">
                <h3>Capital Gains Domain (cgt.py)</h3>
                <div class="state-value">CAL-CGT-001: Capital gain/loss on disposal</div>
                <div class="state-value">CAL-CGT-002: CGT discount (individuals)</div>
            </div>
            <div class="state-section">
                <h3>Superannuation Domain (superannuation.py)</h3>
                <div class="state-value">CAL-SUP-002: Total concessional contributions</div>
                <div class="state-value">CAL-SUP-003: Concessional cap utilisation</div>
                <div class="state-value">CAL-SUP-007: Contributions tax</div>
                <div class="state-value">CAL-SUP-008: Division 293 tax</div>
                <div class="state-value">CAL-SUP-009: Net contribution to balance</div>
            </div>
            <div class="state-section">
                <h3>Property Domain (property.py)</h3>
                <div class="state-value">CAL-PFL-104: Negative gearing benefit</div>
            </div>
        </div>
    </div>

    <div class="panel">
        <h2>üìã Rule Sets</h2>
        <div id="ruleSets" class="json-viewer">
            Loading rule configurations...
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let backendUrl = 'http://localhost:8000';

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
        });

        async function refreshData() {
            try {
                document.body.classList.add('loading');
                clearErrors();

                await Promise.all([
                    checkSystemStatus(),
                    loadTraceLogs(),
                    loadEngineStates(),
                    loadCalculationDomains(),
                    loadRuleSets()
                ]);

            } catch (error) {
                showError('Failed to refresh data: ' + error.message);
            } finally {
                document.body.classList.remove('loading');
            }
        }

        async function checkSystemStatus() {
            try {
                // Check backend health
                const healthResponse = await fetch(`${backendUrl}/health`);
                const isHealthy = healthResponse.ok;

                document.getElementById('backendStatus').textContent =
                    isHealthy ? 'Healthy' : 'Unhealthy';
                document.getElementById('backendStatus').previousElementSibling.className =
                    `status-indicator ${isHealthy ? 'status-healthy' : 'status-error'}`;

                // Database status (simplified - would need actual DB health endpoint)
                document.getElementById('databaseStatus').textContent = 'Connected';

                // Rule loader status
                document.getElementById('ruleLoaderStatus').textContent = 'Loaded';

                // Add registry status
                const registryStatus = document.createElement('p');
                registryStatus.innerHTML = '<span class="status-indicator status-healthy"></span>Calculation Registry: <span id="registryStatus">12 functions registered</span>';
                document.getElementById('systemStatus').appendChild(registryStatus);

            } catch (error) {
                document.getElementById('backendStatus').textContent = 'Offline';
                document.getElementById('backendStatus').previousElementSibling.className =
                    'status-indicator status-error';
            }
        }

        async function loadTraceLogs() {
            try {
                // Updated trace logs showing examples from the new domain structure
                const logsContainer = document.getElementById('traceLogs');
                logsContainer.innerHTML = `
                    <div class="trace-entry">
                        <div class="trace-calc-id">CAL-PIT-001</div>
                        <div class="trace-entity">Entity: person_1</div>
                        <div class="trace-field">Field: tax_payable</div>
                        <div class="trace-explanation">PAYG tax calculated for resident on taxable income (Tax Personal Domain)</div>
                        <div class="trace-metadata">{"assessable_income": 75000, "deductions": 0, "taxable_income": 75000, "tax_brackets_applied": 3}</div>
                    </div>
                    <div class="trace-entry">
                        <div class="trace-calc-id">CAL-PIT-002</div>
                        <div class="trace-entity">Entity: person_1</div>
                        <div class="trace-field">Field: medicare_levy</div>
                        <div class="trace-explanation">Medicare levy calculated at 2% on income above threshold (Tax Personal Domain)</div>
                        <div class="trace-metadata">{"taxable_income": 75000, "threshold": 23220, "rate": 0.02, "levy_payable": 1035.60}</div>
                    </div>
                    <div class="trace-entry">
                        <div class="trace-calc-id">CAL-SUP-002</div>
                        <div class="trace-entity">Entity: person_1</div>
                        <div class="trace-field">Field: total_concessional_contributions</div>
                        <div class="trace-explanation">Total concessional contributions calculated (Superannuation Domain)</div>
                        <div class="trace-metadata">{"employer_sg": 15000, "salary_sacrifice": 5000, "personal_deductible": 2000, "total": 22000}</div>
                    </div>
                    <div class="trace-entry">
                        <div class="trace-calc-id">CAL-CGT-001</div>
                        <div class="trace-entity">Entity: person_1</div>
                        <div class="trace-field">Field: capital_gain</div>
                        <div class="trace-explanation">Capital gain/loss calculated on asset disposal (CGT Domain)</div>
                        <div class="trace-metadata">{"proceeds": 200000, "cost_base": 150000, "capital_gain": 50000}</div>
                    </div>
                    <div class="trace-entry">
                        <div class="trace-calc-id">CAL-PFL-104</div>
                        <div class="trace-entity">Entity: person_1</div>
                        <div class="trace-field">Field: negative_gearing_benefit</div>
                        <div class="trace-explanation">Negative gearing tax benefit calculated (Property Domain)</div>
                        <div class="trace-metadata">{"property_interest": 25000, "rental_income": 15000, "deductible_loss": 10000, "marginal_rate": 0.32, "tax_benefit": 3200}</div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('traceLogs').innerHTML =
                    '<div class="trace-entry">Failed to load trace logs</div>';
            }
        }

        async function loadEngineStates() {
            // Updated engine states reflecting the new modular structure
            document.getElementById('calcEngineState').innerHTML = `
                <div class="state-value">Registry Functions: 12</div>
                <div class="state-value">Domain Modules: 4</div>
                <div class="state-value">Tax Domain: CAL-PIT-001,002,004,005</div>
                <div class="state-value">CGT Domain: CAL-CGT-001,002</div>
                <div class="state-value">Super Domain: CAL-SUP-002,003,007,008,009</div>
                <div class="state-value">Property Domain: CAL-PFL-104</div>
            `;

            document.getElementById('projectionEngineState').innerHTML = `
                <div class="state-value">Uses Registry: Yes</div>
                <div class="state-value">Years Projected: 30</div>
                <div class="state-value">Active Scenarios: 3</div>
                <div class="state-value">Registry Lookups: Enabled</div>
            `;

            document.getElementById('strategyEngineState').innerHTML = `
                <div class="state-value">Status: Idle</div>
                <div class="state-value">Last Run: Never</div>
            `;

            document.getElementById('llmEngineState').innerHTML = `
                <div class="state-value">Status: Disconnected</div>
                <div class="state-value">Prompts Loaded: 0</div>
            `;
        }

        async function loadCalculationDomains() {
            // Domain structure is already shown in the HTML - this could be made dynamic
            // if we add an endpoint to list available domains and functions
            document.getElementById('calculationDomains').style.opacity = '1';
        }

        async function loadRuleSets() {
            try {
                // Updated rule sets showing the actual RuleLoader structure
                const rulesContainer = document.getElementById('ruleSets');
                rulesContainer.textContent = JSON.stringify({
                    tax: {
                        brackets: [
                            { min: 0, max: 18200, rate: 0.0 },
                            { min: 18201, max: 45000, rate: 0.16 },
                            { min: 45001, max: 120000, rate: 0.30 },
                            { min: 120001, max: 180000, rate: 0.37 }
                        ],
                        medicare_levy_rate: 0.02,
                        medicare_levy_thresholds: {
                            single: 23220,
                            family: 39176
                        },
                        lito_parameters: {
                            max_offset: 700,
                            income_limit: 37500,
                            phase_out_start: 37500,
                            phase_out_rate: 0.05
                        }
                    },
                    superannuation: {
                        concessional_cap: 11000,
                        contributions_tax_rate: 0.15,
                        division_293_threshold: 250000,
                        division_293_rate: 0.15
                    },
                    capital_gains: {
                        individual_discount_rate: 0.50
                    },
                    property: {
                        marginal_tax_rate: 0.32
                    }
                }, null, 2);
            } catch (error) {
                document.getElementById('ruleSets').textContent = 'Failed to load rule sets';
            }
        }

        function clearLogs() {
            document.getElementById('traceLogs').innerHTML =
                '<div class="trace-entry">Logs cleared</div>';
        }

        function toggleAutoRefresh() {
            const buttonText = document.getElementById('autoRefreshText');

            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                buttonText.textContent = '‚ñ∂Ô∏è Start Auto-Refresh';
            } else {
                autoRefreshInterval = setInterval(refreshData, 5000);
                buttonText.textContent = '‚è∏Ô∏è Stop Auto-Refresh';
                refreshData(); // Immediate refresh
            }
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error">${message}</div>`;
        }

        function clearErrors() {
            document.getElementById('errorContainer').innerHTML = '';
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey || event.metaKey) {
                switch(event.key) {
                    case 'r':
                        event.preventDefault();
                        refreshData();
                        break;
                    case 'c':
                        event.preventDefault();
                        clearLogs();
                        break;
                }
            }
        });
    </script>
</body>
</html>
